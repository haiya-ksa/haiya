<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هيّا | مجتمع نسائي رياضي في القصيم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            dark: '#333333',
                            light: '#f5f5f5',
                            pink: '#f8a5c2',
                        }
                    },
                    fontFamily: {
                        arabic: ['Tajawal', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f5f5f5;
        }
        
        .hero-section {
            background: linear-gradient(rgba(51, 51, 51, 0.8), rgba(51, 51, 51, 0.8)), 
                        url('https://gcdnb.pbrd.co/images/hCLUXmkSLbBk.png?o=1');
            background-size: cover;
            background-position: center;
        }
        
        .sport-card {
            transition: all 0.3s ease;
        }
        
        .sport-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .calendar-day {
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover:not(.disabled) {
            background-color: #f8a5c2;
            color: white;
        }
        
        .active-day {
            background-color: #f8a5c2;
            color: white;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .logo-img {
            height: 25px;
            width: auto;
        }
    </style>
</head>
<body class="bg-primary-light text-primary-dark">
    <!-- Navigation -->
    <nav class="bg-primary-dark text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img src="logo.png" alt="هيّا" class="logo-img">
            </div>
            <div class="hidden md:flex space-x-6 space-x-reverse">
                <a href="#home" class="hover:text-primary-pink transition">الرئيسية</a>
                <a href="#activities" class="hover:text-primary-pink transition">الأنشطة</a>
                <a href="#booking" class="hover:text-primary-pink transition">الحجز</a>
                <a href="#contact" class="hover:text-primary-pink transition">تواصل معنا</a>
                <a href="#admin" id="admin-link" class="hidden hover:text-primary-pink transition">لوحة التحكم</a>
            </div>
            <button class="md:hidden text-white focus:outline-none" id="mobile-menu-button">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>
        <div class="md:hidden hidden bg-primary-dark px-4 py-2" id="mobile-menu">
            <a href="#home" class="block py-2 hover:text-primary-pink transition">الرئيسية</a>
            <a href="#activities" class="block py-2 hover:text-primary-pink transition">الأنشطة</a>
            <a href="#booking" class="block py-2 hover:text-primary-pink transition">الحجز</a>
            <a href="#contact" class="block py-2 hover:text-primary-pink transition">تواصل معنا</a>
            <a href="#admin" id="mobile-admin-link" class="hidden block py-2 hover:text-primary-pink transition">لوحة التحكم</a>
        </div>
    </nav>

    <!-- Home Page -->
    <section id="home" class="hero-section min-h-screen flex items-center justify-center text-white">
        <div class="container mx-auto px-4 py-20 text-center">
            <h1 class="text-4xl md:text-6xl font-bold mb-6">مرحباً بكم في <span class="text-primary-pink">هيّا!</span></h1>
            <p class="text-xl md:text-2xl mb-8 max-w-3xl mx-auto">
                مُجتمع نسائي رياضي في القصيم، يجمع النساء بمختلف اهتماماتهن الرياضية ويسهل إيجاد المنافسات وحجز الصالات بمنصة واحدة
            </p>
            <a href="#activities" class="bg-primary-pink hover:bg-opacity-90 text-white font-bold py-3 px-8 rounded-full text-lg transition inline-block">
                استكشف الأنشطة
            </a>
        </div>
    </section>

    <!-- Activities Page -->
    <section id="activities" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">الأنشطة الرياضية المتاحة</h2>
            
            <div class="mb-12 text-center">
                <h3 class="text-xl font-semibold mb-4">اختر مدينتك:</h3>
                <div class="flex flex-wrap justify-center gap-4">
                    <button class="city-btn bg-primary-dark text-white px-6 py-2 rounded-full hover:bg-opacity-90 transition" data-city="بريدة">بريدة</button>
                    <button class="city-btn bg-gray-200 px-6 py-2 rounded-full hover:bg-gray-300 transition" data-city="عنيزة">عنيزة</button>
                    <button class="city-btn bg-gray-200 px-6 py-2 rounded-full hover:bg-gray-300 transition" data-city="الرس">الرس</button>
                    <button class="city-btn bg-gray-200 px-6 py-2 rounded-full hover:bg-gray-300 transition" data-city="البدائع">البدائع</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Basketball -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-basketball-ball text-6xl text-orange-300"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">كرة السلة</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="كرة السلة">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
                
                <!-- Badminton -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-feather text-6xl text-sky-300"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">تنس الريشة</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="تنس الريشة">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
                
                <!-- Football -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-futbol text-6xl text-violet-300"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">كرة القدم</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="كرة القدم">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
                
                <!-- Volleyball -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-volleyball-ball text-6xl text-yellow-300"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">كرة الطائرة</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="كرة الطائرة">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
                
                <!-- Tennis -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-baseball text-6xl text-lime-300"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">التنس الارضي</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="التنس">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
                
                <!-- Archery -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-bullseye text-6xl text-black-500"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">السهام</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="السهام">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Calendar Page (Hidden by default) -->
    <section id="calendar-section" class="py-16 bg-gray-50 hidden">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold" id="calendar-title">مواعيد <span id="sport-name"></span> في <span id="city-name"></span></h2>
                <button class="back-to-activities bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                    العودة للأنشطة
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <button id="prev-week" class="bg-primary-dark text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition">
                        الأسبوع السابق
                    </button>
                    <h3 class="text-xl font-semibold" id="week-range">الأسبوع الحالي</h3>
                    <button id="next-week" class="bg-primary-dark text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition">
                        الأسبوع القادم
                    </button>
                </div>
                
                <div class="overflow-x-auto no-scrollbar">
                    <div class="min-w-max">
                        <div class="grid grid-cols-7 gap-4 mb-4">
                            <div class="text-center font-bold py-2">الأحد</div>
                            <div class="text-center font-bold py-2">الاثنين</div>
                            <div class="text-center font-bold py-2">الثلاثاء</div>
                            <div class="text-center font-bold py-2">الأربعاء</div>
                            <div class="text-center font-bold py-2">الخميس</div>
                            <div class="text-center font-bold py-2">الجمعة</div>
                            <div class="text-center font-bold py-2">السبت</div>
                        </div>
                        
                        <div class="grid grid-cols-7 gap-4" id="calendar-days">
                            <!-- Calendar days will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-12 bg-white rounded-xl shadow-md p-6 hidden" id="time-slots-container">
                <h3 class="text-xl font-semibold mb-4" id="selected-date">المواعيد المتاحة ليوم <span></span></h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="time-slots">
                    <!-- Time slots will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </section>

    <!-- Booking & Payment Page -->
    <section id="booking" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">إتمام الحجز</h2>
            
            <div class="max-w-3xl mx-auto bg-gray-50 rounded-xl shadow-md p-8">
                <div class="mb-8 p-4 bg-primary-pink bg-opacity-10 rounded-lg border-l-4 border-primary-pink">
                    <h3 class="text-xl font-semibold mb-2">تفاصيل الحجز</h3>
                    <p id="booking-details" class="text-gray-700">الرياضة: <span id="booking-sport"></span> | المدينة: <span id="booking-city"></span> | التاريخ: <span id="booking-date"></span> | الوقت: <span id="booking-time"></span></p>
                </div>
                
                <form id="booking-form" class="space-y-6">
                    <!-- Hidden Fields for Booking Details -->
                    <input type="hidden" id="hidden-sport">
                    <input type="hidden" id="hidden-city">
                    <input type="hidden" id="hidden-date">
                    <input type="hidden" id="hidden-time">
                    <input type="hidden" id="hidden-price">
                    
                    <div>
                        <label for="full-name" class="block text-lg font-medium mb-2">الاسم الكامل</label>
                        <input type="text" id="full-name" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-pink focus:border-transparent" required>
                    </div>
                    
                    <div>
                        <label for="phone" class="block text-lg font-medium mb-2">رقم الجوال</label>
                        <input type="tel" id="phone" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-pink focus:border-transparent" required>
                    </div>
                    
                    <div>
                        <label for="email" class="block text-lg font-medium mb-2">البريد الإلكتروني</label>
                        <input type="email" id="email" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-pink focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="notes" class="block text-lg font-medium mb-2">ملاحظات إضافية (اختياري) + اذا تفضلين تنسيق مُنافساتك أو فريقك بنفس فئتك العمرية، فضلاً اذكري عمرك </label>
                        <textarea id="notes" rows="3" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-pink focus:border-transparent"></textarea>
                    </div>
                    
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-4">طريقة الدفع</h3>
                        <p class="mb-4">الدفع عن طريق STC Pay فقط:</p>
                        
                        <div class="flex items-center space-x-4 space-x-reverse mb-4">
                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                <i class="fas fa-mobile-alt text-3xl text-primary-pink"></i>
                            </div>
                            <div>
                                <p class="font-medium">STC Pay</p>
                                <p class="text-gray-600">رقم الجوال: <span class="font-bold">0582068727</span></p>
                                <p class="text-gray-600">المبلغ: <span class="font-bold" id="booking-price">75 ريال</span></p>
                            </div>
                        </div>
                        
                        <p class="text-sm text-gray-600">يرجى إرسال صورة إثبات التحويل عبر الواتساب بعد إتمام الحجز لتأكيد موعدك.</p>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="terms" class="w-5 h-5 rounded border-gray-300 text-primary-pink focus:ring-primary-pink" required>
                        <label for="terms" class="mr-2 text-gray-700">أوافق على الشروط والأحكام</label>
                    </div>
                    
                    <button type="submit" class="w-full bg-primary-pink hover:bg-opacity-90 text-white font-bold py-3 px-4 rounded-lg text-lg transition">
                        تأكيد الحجز
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- Admin Dashboard (Hidden by default) -->
    <section id="admin" class="py-16 bg-gray-50 hidden">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-8">لوحة التحكم</h2>
            
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold">إدارة الحجوزات</h3>
                    <div class="flex space-x-4 space-x-reverse">
                        <input type="text" id="admin-search" placeholder="ابحث بالاسم أو الجوال..." class="px-4 py-2 border rounded-lg">
                        <select id="admin-filter" class="px-4 py-2 border rounded-lg">
                            <option value="all">جميع الحجوزات</option>
                            <option value="Pending">قيد الانتظار</option>
                            <option value="Confirmed">مؤكدة</option>
                            <option value="Cancelled">ملغاة</option>
                        </select>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100">
                                <th class="p-3 text-right">الاسم</th>
                                <th class="p-3 text-right">الجوال</th>
                                <th class="p-3 text-right">الرياضة</th>
                                <th class="p-3 text-right">المدينة</th>
                                <th class="p-3 text-right">التاريخ</th>
                                <th class="p-3 text-right">الوقت</th>
                                <th class="p-3 text-right">الحالة</th>
                                <th class="p-3 text-right">إجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="admin-bookings">
                            <!-- Bookings will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- Contact Page -->
    <section id="contact" class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">تواصل معنا</h2>
            
            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-md p-6 text-center">
                    <div class="w-16 h-16 bg-primary-pink bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fab fa-whatsapp text-2xl text-primary-pink"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">واتساب</h3>
                    <p class="text-gray-600 mb-2">0582068727</p>
                    <a href="https://wa.me/966582068727" class="text-primary-pink hover:underline">ارسال رسالة</a>
                </div>
                
                <div class="bg-white rounded-xl shadow-md p-6 text-center">
                    <div class="w-16 h-16 bg-primary-pink bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fab fa-instagram text-2xl text-primary-pink"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">إنستجرام</h3>
                    <p class="text-gray-600 mb-2">@haiya.ksa</p>
                    <a href="https://instagram.com/haiya.ksa" class="text-primary-pink hover:underline">زيارة الصفحة</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-primary-dark text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center space-x-2">
                        <img src="logo.png" alt="هيّا" class="logo-img">
                    </div>
                    <p class="mt-2 text-gray-300">صُنع بعد سنين من الانتظار، لجعل الرياضة متاحة لجميع النساء
Ladies, it's time!</p>
                </div>
                
                <div class="flex space-x-6 space-x-reverse">
                    <a href="https://instagram.com/haiya.ksa" class="hover:text-primary-pink transition">
                        <i class="fab fa-instagram text-2xl"></i>
                    </a>
                    <a href="https://wa.me/966582068727" class="hover:text-primary-pink transition">
                        <i class="fab fa-whatsapp text-2xl"></i>
                    </a>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-300">
                <p>© <script>document.write(new Date().getFullYear())</script> هيّا. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-check text-3xl text-green-500"></i>
            </div>
            <h3 class="text-2xl font-bold mb-4">تم الحجز بنجاح!</h3>
            <p class="text-gray-600 mb-6" id="success-message">تم تأكيد حجزك بنجاح وسنتواصل معك قريباً.</p>
            <p class="text-gray-600 mb-6">يرجى إرسال إثبات التحويل عبر الواتساب لتأكيد الحجز.</p>
            <button id="close-modal" class="bg-primary-pink hover:bg-opacity-90 text-white font-bold py-2 px-6 rounded-lg transition">
                حسناً
            </button>
        </div>
    </div>

    <!-- Firebase and App Scripts -->
    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.1/firebase-app.js";
        import { getDatabase, ref, push, set, query, orderByChild, equalTo, onValue, update, remove } 
              from "https://www.gstatic.com/firebasejs/10.11.1/firebase-database.js";

        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyARaAimHiNzNef6AZ2LKHl0a2V_euo2JYg",
            authDomain: "booking-haiya.firebaseapp.com",
            databaseURL: "https://booking-haiya-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "booking-haiya",
            storageBucket: "booking-haiya.appspot.com",
            messagingSenderId: "920297070543",
            appId: "1:920297070543:web:3e216c54a933b493fcfcba",
            measurementId: "G-57T61BEJWD"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ========== SPORTS AVAILABILITY ==========
        const baseAvailability = {
            "بريدة": {
                "كرة السلة": {
                    availableDays: [0, 2, 4], // Sunday, Tuesday, Thursday
                    timeSlots: [
                        { time: '4:00 مساءً', max: 10, price: 75 },
                        { time: '6:00 مساءً', max: 10, price: 75 }
                    ]
                },
                "تنس الريشة": {
                    availableDays: [1, 3], // Monday, Wednesday
                    timeSlots: [
                        { time: '5:00 مساءً', max: 8, price: 60 }
                    ]
                },
                "كرة القدم": {
                    availableDays: [0, 3, 5], // Sunday, Wednesday, Friday
                    timeSlots: [
                        { time: '5:30 مساءً', max: 12, price: 80 }
                    ]
                },
                "كرة الطائرة": {
                    availableDays: [1, 4], // Monday, Thursday
                    timeSlots: [
                        { time: '4:00 مساءً', max: 12, price: 70 }
                    ]
                },
                "التنس": {
                    availableDays: [2, 5], // Tuesday, Friday
                    timeSlots: [
                        { time: '3:30 مساءً', max: 4, price: 90 }
                    ]
                },
                "السهام": {
                    availableDays: [0, 3], // Sunday, Wednesday
                    timeSlots: [
                        { time: '4:00 مساءً', max: 6, price: 65 }
                    ]
                }
            },
            "عنيزة": {
                "كرة السلة": {
                    availableDays: [1, 3], // Monday, Wednesday
                    timeSlots: [
                        { time: '5:00 مساءً', max: 8, price: 75 }
                    ]
                },
                "كرة القدم": {
                    availableDays: [0, 4], // Sunday, Thursday
                    timeSlots: [
                        { time: '6:00 مساءً', max: 10, price: 80 }
                    ]
                }
            },
            "الرس": {
                "كرة السلة": {
                    availableDays: [2, 5], // Tuesday, Friday
                    timeSlots: [
                        { time: '4:30 مساءً', max: 8, price: 75 }
                    ]
                }
            },
            "البدائع": {
                "كرة القدم": {
                    availableDays: [1, 4], // Monday, Thursday
                    timeSlots: [
                        { time: '5:00 مساءً', max: 10, price: 80 }
                    ]
                }
            }
        };

        // ========== GLOBAL VARIABLES ==========
        let currentCity = "بريدة";
        let currentSport = "";
        let currentWeekOffset = 0;
        let selectedDate = null;

        // ========== DOM ELEMENTS ==========
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        const cityButtons = document.querySelectorAll('.city-btn');
        const viewCalendarButtons = document.querySelectorAll('.view-calendar-btn');
        const backToActivitiesBtn = document.querySelector('.back-to-activities');
        const calendarSection = document.getElementById('calendar-section');
        const activitiesSection = document.getElementById('activities');
        const calendarTitle = document.getElementById('calendar-title');
        const sportNameSpan = document.getElementById('sport-name');
        const cityNameSpan = document.getElementById('city-name');
        const weekRangeSpan = document.getElementById('week-range');
        const calendarDays = document.getElementById('calendar-days');
        const prevWeekBtn = document.getElementById('prev-week');
        const nextWeekBtn = document.getElementById('next-week');
        const timeSlotsContainer = document.getElementById('time-slots-container');
        const selectedDateSpan = document.querySelector('#selected-date span');
        const timeSlots = document.getElementById('time-slots');
        const bookingSport = document.getElementById('booking-sport');
        const bookingCity = document.getElementById('booking-city');
        const bookingDate = document.getElementById('booking-date');
        const bookingTime = document.getElementById('booking-time');
        const bookingPrice = document.getElementById('booking-price');
        const hiddenSport = document.getElementById('hidden-sport');
        const hiddenCity = document.getElementById('hidden-city');
        const hiddenDate = document.getElementById('hidden-date');
        const hiddenTime = document.getElementById('hidden-time');
        const hiddenPrice = document.getElementById('hidden-price');
        const bookingForm = document.getElementById('booking-form');
        const successModal = document.getElementById('success-modal');
        const closeModalBtn = document.getElementById('close-modal');

        // ========== EVENT LISTENERS ==========
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        cityButtons.forEach(button => {
            button.addEventListener('click', () => {
                cityButtons.forEach(btn => {
                    btn.classList.remove('bg-primary-dark', 'text-white');
                    btn.classList.add('bg-gray-200');
                });
                button.classList.remove('bg-gray-200');
                button.classList.add('bg-primary-dark', 'text-white');
                currentCity = button.dataset.city;
            });
        });

        viewCalendarButtons.forEach(button => {
            button.addEventListener('click', () => {
                currentSport = button.dataset.sport;
                currentWeekOffset = 0;
                updateCalendar();
                activitiesSection.classList.add('hidden');
                calendarSection.classList.remove('hidden');
                window.scrollTo(0, 0);
            });
        });

        backToActivitiesBtn.addEventListener('click', () => {
            calendarSection.classList.add('hidden');
            activitiesSection.classList.remove('hidden');
            window.scrollTo(0, 0);
        });

        prevWeekBtn.addEventListener('click', () => {
            currentWeekOffset--;
            updateCalendar();
        });

        nextWeekBtn.addEventListener('click', () => {
            currentWeekOffset++;
            updateCalendar();
        });

        bookingForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!document.getElementById('terms').checked) {
                alert('يرجى الموافقة على الشروط والأحكام');
                return;
            }

            const city = bookingCity.textContent;
            const sport = bookingSport.textContent;
            const date = bookingDate.textContent;
            const time = bookingTime.textContent;
            
            const bookingData = {
                name: document.getElementById('full-name').value,
                phone: document.getElementById('phone').value,
                email: document.getElementById('email').value,
                notes: document.getElementById('notes').value,
                city: city,
                sport: sport,
                date: date,
                time: time,
                price: hiddenPrice.value,
                status: "Pending",
                compositeKey: `${city}_${sport}_${date}_${time}`
            };

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ';

            try {
                const available = await getAvailableSlots(city, sport, date, time);
                if (available <= 0) {
                    throw new Error('هذا الموعد لم يعد متاحاً');
                }
                
                const success = await saveBooking(bookingData);
                if (success) {
                    document.getElementById('success-message').textContent = 
                        `تم تأكيد حجز ${bookingData.name} لرياضة ${bookingData.sport}`;
                    document.getElementById('success-modal').classList.remove('hidden');
                    this.reset();
                }
            } catch (error) {
                alert(`حدث خطأ: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'تأكيد الحجز';
            }
        });

        closeModalBtn.addEventListener('click', function() {
            successModal.classList.add('hidden');
        });

        // ========== CALENDAR FUNCTIONS ==========
        function updateCalendar() {
            // Update title
            sportNameSpan.textContent = currentSport;
            cityNameSpan.textContent = currentCity;
            
            // Get current week dates
            const now = new Date();
            const currentDay = now.getDay(); // 0 = Sunday, 1 = Monday, etc.
            const currentDate = now.getDate();
            
            // Calculate start of week (Sunday)
            const startOfWeek = new Date(now);
            startOfWeek.setDate(currentDate - currentDay + (currentWeekOffset * 7));
            
            // Calculate end of week (Saturday)
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(startOfWeek.getDate() + 6);
            
            // Update week range display
            const options = { month: 'long', day: 'numeric' };
            weekRangeSpan.textContent = `من ${startOfWeek.toLocaleDateString('ar-EG', options)} إلى ${endOfWeek.toLocaleDateString('ar-EG', options)}`;
            
            // Clear previous days
            calendarDays.innerHTML = '';
            
            // Populate calendar days
            for (let i = 0; i < 7; i++) {
                const dayDate = new Date(startOfWeek);
                dayDate.setDate(startOfWeek.getDate() + i);
                
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day text-center py-4 rounded-lg cursor-pointer';
                
                // Check if this day is available for the selected sport
                const sportAvailability = baseAvailability[currentCity]?.[currentSport];
                const isAvailable = sportAvailability?.availableDays.includes(i);
                
                if (!isAvailable) {
                    dayElement.classList.add('disabled', 'bg-gray-100', 'text-gray-400');
                    dayElement.classList.remove('cursor-pointer');
                } else {
                    dayElement.classList.add('hover:bg-primary-pink', 'hover:text-white');
                    if (selectedDate && dayDate.toDateString() === selectedDate.toDateString()) {
                        dayElement.classList.add('active-day');
                    }
                }
                
                dayElement.innerHTML = `
                    <div class="font-bold">${dayDate.toLocaleDateString('ar-EG', { day: 'numeric' })}</div>
                    <div class="text-sm">${getDayName(i)}</div>
                `;
                
                if (isAvailable) {
                    dayElement.addEventListener('click', () => {
                        selectDate(dayDate);
                    });
                }
                
                calendarDays.appendChild(dayElement);
            }
        }

        function getDayName(dayIndex) {
            const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
            return days[dayIndex];
        }

        async function selectDate(date) {
            selectedDate = date;
            updateCalendar();
            
            // Show loading state
            timeSlotsContainer.classList.remove('hidden');
            timeSlots.innerHTML = '<div class="col-span-3 py-8 text-center"><i class="fas fa-spinner fa-spin text-2xl"></i></div>';
            
            // Format date for display
            const options = { weekday: 'long', month: 'long', day: 'numeric' };
            selectedDateSpan.textContent = date.toLocaleDateString('ar-EG', options);
            
            // Get time slots for selected sport and city
            const sportAvailability = baseAvailability[currentCity][currentSport];
            
            // Clear previous time slots
            timeSlots.innerHTML = '';
            
            // Populate time slots
            for (const slot of sportAvailability.timeSlots) {
                const available = await getAvailableSlots(currentCity, currentSport, formatDate(date), slot.time);
                
                const slotElement = document.createElement('div');
                slotElement.className = 'bg-white border rounded-lg p-4 text-center';
                
                slotElement.innerHTML = `
                    <div class="font-bold text-lg mb-2">${slot.time}</div>
                    <div class="text-gray-600 mb-3">${available} / ${slot.max} متاح</div>
                    <div class="font-bold text-primary-dark mb-3">${slot.price} ريال</div>
                    <button class="book-btn w-full bg-primary-pink hover:bg-opacity-90 text-white py-2 rounded-lg transition" 
                            data-time="${slot.time}" data-price="${slot.price}">
                        احجز الآن
                    </button>
                `;
                
                if (available <= 0) {
                    slotElement.querySelector('.book-btn').disabled = true;
                    slotElement.querySelector('.book-btn').classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    slotElement.querySelector('.book-btn').addEventListener('click', (e) => {
                        e.preventDefault();
                        bookTimeSlot(slot.time, slot.price);
                    });
                }
                
                timeSlots.appendChild(slotElement);
            }
        }

        function formatDate(date) {
            const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
            return date.toLocaleDateString('ar-EG', options).replace(/\s/g, '');
        }

        function bookTimeSlot(time, price) {
            // Update booking details
            bookingSport.textContent = currentSport;
            bookingCity.textContent = currentCity;
            bookingDate.textContent = selectedDate.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            bookingTime.textContent = time;
            bookingPrice.textContent = price + ' ريال';
            
            // Update hidden fields
            hiddenSport.value = currentSport;
            hiddenCity.value = currentCity;
            hiddenDate.value = formatDate(selectedDate);
            hiddenTime.value = time;
            hiddenPrice.value = price;
            
            // Scroll to booking section
            calendarSection.classList.add('hidden');
            document.getElementById('booking').scrollIntoView({ behavior: 'smooth' });
        }

        // ========== BOOKING FUNCTIONS ==========
        async function saveBooking(bookingData) {
            try {
                const bookingsRef = ref(db, 'bookings');
                const newBookingRef = push(bookingsRef);
                await set(newBookingRef, {
                    ...bookingData,
                    timestamp: Date.now()
                });
                return true;
            } catch (error) {
                console.error("Error saving booking:", error);
                return false;
            }
        }

        async function getAvailableSlots(city, sport, date, time) {
            const bookingsRef = ref(db, 'bookings');
            const bookingQuery = query(
                bookingsRef,
                orderByChild('compositeKey'),
                equalTo(`${city}_${sport}_${date}_${time}`)
            );
            
            const snapshot = await new Promise(resolve => 
                onValue(bookingQuery, resolve, { onlyOnce: true })
            );
            
            const bookings = snapshot.val() || {};
            const baseSlot = baseAvailability[city]?.[sport]?.timeSlots?.find(s => s.time === time);
            return baseSlot ? Math.max(0, baseSlot.max - Object.keys(bookings).length) : 0;
        }

        // ========== ADMIN FUNCTIONS ==========
        function loadAdminBookings() {
            const bookingsRef = ref(db, 'bookings');
            onValue(bookingsRef, (snapshot) => {
                const bookings = snapshot.val() || {};
                const tableBody = document.getElementById('admin-bookings');
                tableBody.innerHTML = '';
                
                Object.entries(bookings).forEach(([id, booking]) => {
                    const row = document.createElement('tr');
                    row.className = 'border-b hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="p-3">${booking.name}</td>
                        <td class="p-3">${booking.phone}</td>
                        <td class="p-3">${booking.sport}</td>
                        <td class="p-3">${booking.city}</td>
                        <td class="p-3">${booking.date}</td>
                        <td class="p-3">${booking.time}</td>
                        <td class="p-3">
                            <select class="status-select border p-1 rounded" data-id="${id}">
                                <option value="Pending" ${booking.status === 'Pending' ? 'selected' : ''}>قيد الانتظار</option>
                                <option value="Confirmed" ${booking.status === 'Confirmed' ? 'selected' : ''}>مؤكدة</option>
                                <option value="Cancelled" ${booking.status === 'Cancelled' ? 'selected' : ''}>ملغاة</option>
                            </select>
                        </td>
                        <td class="p-3">
                            <button class="delete-booking text-red-500 hover:text-red-700" data-id="${id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Add event listeners
                document.querySelectorAll('.status-select').forEach(select => {
                    select.addEventListener('change', (e) => {
                        updateStatus(e.target.dataset.id, e.target.value);
                    });
                });
                
                document.querySelectorAll('.delete-booking').forEach(button => {
                    button.addEventListener('click', (e) => {
                        deleteBooking(e.target.closest('button').dataset.id);
                    });
                });
            });
        }

        function updateStatus(bookingId, newStatus) {
            update(ref(db, `bookings/${bookingId}`), { status: newStatus });
        }

        function deleteBooking(bookingId) {
            if (confirm('هل أنت متأكد من حذف هذه الحجز؟')) {
                remove(ref(db, `bookings/${bookingId}`));
            }
        }

        // ========== INITIALIZATION ==========
        // Show admin panel when URL has #admin
        if (window.location.hash === '#admin') {
            document.getElementById('admin').classList.remove('hidden');
            document.getElementById('admin-link').classList.remove('hidden');
            document.getElementById('mobile-admin-link').classList.remove('hidden');
            loadAdminBookings();
        }

        // Initialize default city button as active
        document.querySelector('.city-btn[data-city="بريدة"]').click();
    </script>
</body>
</html>
