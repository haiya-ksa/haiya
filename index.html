<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>هيّا | مجتمع نسائي رياضي في القصيم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
<!-- Firebase SDK v8 (compatible with GitHub Pages) -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyARaAimHiNzNef6AZ2LKHl0a2V_euo2JYg",
    authDomain: "booking-haiya.firebaseapp.com",
    databaseURL: "https://booking-haiya-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "booking-haiya",
    storageBucket: "booking-haiya.appspot.com",
    messagingSenderId: "920297070543",
    appId: "1:920297070543:web:3e216c54a933b493fcfcba",
    measurementId: "G-57T61BEJWD"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
</script>
    
     <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            dark: '#333333',
                            light: '#f5f5f5',
                            pink: '#f8a5c2',
                        }
                    },
                    fontFamily: {
                        arabic: ['Tajawal', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap');
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: #f5f5f5;
        }
        
        .hero-section {
            background: linear-gradient(rgba(51, 51, 51, 0.8), rgba(51, 51, 51, 0.8)), 
                        url('https://gcdnb.pbrd.co/images/hCLUXmkSLbBk.png?o=1');
            background-size: cover;
            background-position: center;
        }
        
        .sport-card {
            transition: all 0.3s ease;
        }
        
        .sport-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        .calendar-day {
            transition: all 0.2s ease;
        }
        
        .calendar-day:hover:not(.disabled) {
            background-color: #f8a5c2;
            color: white;
        }
        
        .active-day {
            background-color: #f8a5c2;
            color: white;
        }
        
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .logo-img {
            height: 25px;
            width: auto;
        }

        #success-modal {
            transition: opacity 0.3s ease;
        }
        #success-modal.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #success-modal > div {
            transition: transform 0.3s ease;
        }
        #success-modal.hidden > div {
            transform: translateY(-20px);
        }
    </style>
</head>
<body class="bg-primary-light text-primary-dark">
    <!-- Navigation -->
    <nav class="bg-primary-dark text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <img src="logo.png" alt="هيّا" class="logo-img">
            </div>
            <div class="hidden md:flex space-x-6 space-x-reverse">
                <a href="#home" class="hover:text-primary-pink transition">الرئيسية</a>
                <a href="#activities" class="hover:text-primary-pink transition">الأنشطة</a>
                <a href="#booking" class="hover:text-primary-pink transition">الحجز</a>
                <a href="#contact" class="hover:text-primary-pink transition">تواصل معنا</a>
            </div>
            <button class="md:hidden text-white focus:outline-none" id="mobile-menu-button">
                <i class="fas fa-bars text-2xl"></i>
            </button>
        </div>
        <div class="md:hidden hidden bg-primary-dark px-4 py-2" id="mobile-menu">
            <a href="#home" class="block py-2 hover:text-primary-pink transition">الرئيسية</a>
            <a href="#activities" class="block py-2 hover:text-primary-pink transition">الأنشطة</a>
            <a href="#booking" class="block py-2 hover:text-primary-pink transition">الحجز</a>
            <a href="#contact" class="block py-2 hover:text-primary-pink transition">تواصل معنا</a>
        </div>
    </nav>
        <!-- Mobile menu -->
        <div class="md:hidden hidden bg-primary-dark px-4 py-2" id="mobile-menu">
            <a href="#home" class="block py-2 hover:text-primary-pink transition">الرئيسية</a>
            <a href="#activities" class="block py-2 hover:text-primary-pink transition">الأنشطة</a>
            <a href="#booking" class="block py-2 hover:text-primary-pink transition">الحجز</a>
            <a href="#contact" class="block py-2 hover:text-primary-pink transition">تواصل معنا</a>
        </div>
    </nav>

    <!-- Home Page -->
    <section id="home" class="hero-section min-h-screen flex items-center justify-center text-white">
        <div class="container mx-auto px-4 py-20 text-center">
            <h1 class="text-4xl md:text-6xl font-bold mb-6">مرحباً بكم في <span class="text-primary-pink">هيّا!</span></h1>
            <p class="text-xl md:text-2xl mb-8 max-w-3xl mx-auto">
                مُجتمع نسائي رياضي في القصيم، يجمع النساء بمختلف اهتماماتهن الرياضية ويسهل إيجاد المنافسات وحجز الصالات بمنصة واحدة
            </p>
            <a href="#activities" class="bg-primary-pink hover:bg-opacity-90 text-white font-bold py-3 px-8 rounded-full text-lg transition inline-block">
                استكشف الأنشطة
            </a>
        </div>
    </section>

    <!-- Activities Page -->
    <section id="activities" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">الأنشطة الرياضية المتاحة</h2>
            
            <div class="mb-12 text-center">
                <h3 class="text-xl font-semibold mb-4">اختر مدينتك:</h3>
                <div class="flex flex-wrap justify-center gap-4">
                    <button class="city-btn bg-primary-dark text-white px-6 py-2 rounded-full hover:bg-opacity-90 transition" data-city="بريدة">بريدة</button>
                    <button class="city-btn bg-gray-200 px-6 py-2 rounded-full hover:bg-gray-300 transition" data-city="عنيزة">عنيزة</button>
                    <button class="city-btn bg-gray-200 px-6 py-2 rounded-full hover:bg-gray-300 transition" data-city="الرس">الرس</button>
                    <button class="city-btn bg-gray-200 px-6 py-2 rounded-full hover:bg-gray-300 transition" data-city="البدائع">البدائع</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                <!-- Basketball -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-basketball-ball text-6xl text-orange-300"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">كرة السلة</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="كرة السلة">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
                
                <!-- Badminton -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-feather text-6xl text-sky-300"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">تنس الريشة</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="تنس الريشة">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
                
                <!-- Football -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-futbol text-6xl text-violet-300"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">كرة القدم</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="كرة القدم">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
                
                <!-- Volleyball -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-volleyball-ball text-6xl text-yellow-300"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">كرة الطائرة</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="كرة الطائرة">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
                
                <!-- Tennis -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-baseball text-6xl text-lime-300"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">التنس الارضي</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="التنس">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
                
                <!-- Archery -->
                <div class="sport-card bg-white rounded-xl shadow-md overflow-hidden border border-gray-100">
                    <div class="h-48 bg-gray-200 flex items-center justify-center">
                        <i class="fas fa-bullseye text-6xl text-black-500"></i>
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-2">السهام</h3>
                        <button class="view-calendar-btn w-full bg-primary-dark text-white py-2 rounded-lg hover:bg-opacity-90 transition" data-sport="السهام">
                            عرض المواعيد
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Calendar Page (Hidden by default) -->
    <section id="calendar-section" class="py-16 bg-gray-50 hidden">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold" id="calendar-title">مواعيد <span id="sport-name"></span> في <span id="city-name"></span></h2>
                <button class="back-to-activities bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition">
                    العودة للأنشطة
                </button>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex justify-between items-center mb-6">
                    <button id="prev-week" class="bg-primary-dark text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition">
                        الأسبوع السابق
                    </button>
                    <h3 class="text-xl font-semibold" id="week-range">الأسبوع الحالي</h3>
                    <button id="next-week" class="bg-primary-dark text-white px-4 py-2 rounded-lg hover:bg-opacity-90 transition">
                        الأسبوع القادم
                    </button>
                </div>
                
                <div class="overflow-x-auto no-scrollbar">
                    <div class="min-w-max">
                        <div class="grid grid-cols-7 gap-4 mb-4">
                            <div class="text-center font-bold py-2">الأحد</div>
                            <div class="text-center font-bold py-2">الاثنين</div>
                            <div class="text-center font-bold py-2">الثلاثاء</div>
                            <div class="text-center font-bold py-2">الأربعاء</div>
                            <div class="text-center font-bold py-2">الخميس</div>
                            <div class="text-center font-bold py-2">الجمعة</div>
                            <div class="text-center font-bold py-2">السبت</div>
                        </div>
                        
                        <div class="grid grid-cols-7 gap-4" id="calendar-days">
                            <!-- Calendar days will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="mt-12 bg-white rounded-xl shadow-md p-6 hidden" id="time-slots-container">
                <h3 class="text-xl font-semibold mb-4" id="selected-date">المواعيد المتاحة ليوم <span></span></h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="time-slots">
                    <!-- Time slots will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </section>

    <!-- Booking Form Section -->
    <section id="booking" class="py-16 bg-white">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">إتمام الحجز</h2>
            
            <div class="max-w-3xl mx-auto bg-gray-50 rounded-xl shadow-md p-8">
                <div class="mb-8 p-4 bg-primary-pink bg-opacity-10 rounded-lg border-l-4 border-primary-pink">
                    <h3 class="text-xl font-semibold mb-2">تفاصيل الحجز</h3>
                    <p id="booking-details" class="text-gray-700">الرياضة: <span id="booking-sport"></span> | المدينة: <span id="booking-city"></span> | التاريخ: <span id="booking-date"></span> | الوقت: <span id="booking-time"></span></p>
                </div>
                
                <form id="booking-form" action="https://formsubmit.co/haiya.saudi@gmail.com" method="POST" class="space-y-6">
                    <!-- FormSubmit Hidden Fields -->
                    <input type="hidden" name="_subject" value="حجز جديد - هيّا">
                    <input type="hidden" name="_template" value="table">
                    <input type="hidden" name="_next" value="#success">
                    <input type="hidden" name="_captcha" value="false">
                    
                    <!-- Hidden Fields for Both Systems -->
                    <input type="hidden" name="الرياضة" id="hidden-sport">
                    <input type="hidden" name="المدينة" id="hidden-city">
                    <input type="hidden" name="التاريخ" id="hidden-date">
                    <input type="hidden" name="الوقت" id="hidden-time">
                    <input type="hidden" name="السعر" id="hidden-price">

                    <input type="hidden" id="hidden-formatted-date">

                    
                    <div>
                        <label for="full-name" class="block text-lg font-medium mb-2">الاسم الكامل</label>
                        <input type="text" id="full-name" name="الاسم الكامل" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-pink focus:border-transparent" required>
                    </div>
                    
                    <div>
                        <label for="phone" class="block text-lg font-medium mb-2">رقم الجوال</label>
                        <input type="tel" id="phone" name="رقم الجوال" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-pink focus:border-transparent" required>
                    </div>
                    
                    <div>
                        <label for="email" class="block text-lg font-medium mb-2">البريد الإلكتروني</label>
                        <input type="email" id="email" name="البريد الإلكتروني" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-pink focus:border-transparent">
                    </div>
                    
                    <div>
                        <label for="notes" class="block text-lg font-medium mb-2">ملاحظات إضافية (اختياري) + اذا تفضلين تنسيق مُنافساتك أو فريقك بنفس فئتك العمرية، فضلاً اذكري عمرك </label>
                        <textarea id="notes" name="ملاحظات" rows="3" class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary-pink focus:border-transparent"></textarea>
                    </div>
                    
                    <div class="bg-gray-100 p-4 rounded-lg">
                        <h3 class="text-xl font-semibold mb-4">طريقة الدفع</h3>
                        <p class="mb-4">الدفع عن طريق STC Pay فقط:</p>
                        
                        <div class="flex items-center space-x-4 space-x-reverse mb-4">
                            <div class="bg-white p-3 rounded-lg shadow-sm">
                                <i class="fas fa-mobile-alt text-3xl text-primary-pink"></i>
                            </div>
                            <div>
                                <p class="font-medium">STC Pay</p>
                                <p class="text-gray-600">رقم الجوال: <span class="font-bold">0582068727</span></p>
                                <p class="text-gray-600">المبلغ: <span class="font-bold" id="booking-price">75 ريال</span></p>
                            </div>
                        </div>
                        
                        <p class="text-sm text-gray-600">يرجى إرسال صورة إثبات التحويل عبر الواتساب بعد إتمام الحجز لتأكيد موعدك.</p>
                    </div>
                    
                    <div class="flex items-center">
                        <input type="checkbox" id="terms" name="موافق على الشروط" class="w-5 h-5 rounded border-gray-300 text-primary-pink focus:ring-primary-pink" required>
                        <label for="terms" class="mr-2 text-gray-700">أوافق على الشروط والأحكام</label>
                    </div>
                    
                    <button type="submit" class="w-full bg-primary-pink hover:bg-opacity-90 text-white font-bold py-3 px-4 rounded-lg text-lg transition">
                        تأكيد الحجز
                    </button>
                </form>
            </div>
        </div>
    </section>

    <!-- Contact Page -->
    <section id="contact" class="py-16 bg-gray-50">
        <div class="container mx-auto px-4">
            <h2 class="text-3xl font-bold text-center mb-12">تواصل معنا</h2>
            
            <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8">
                <div class="bg-white rounded-xl shadow-md p-6 text-center">
                    <div class="w-16 h-16 bg-primary-pink bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fab fa-whatsapp text-2xl text-primary-pink"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">واتساب</h3>
                    <p class="text-gray-600 mb-2">0582068727</p>
                    <a href="https://wa.me/966582068727" class="text-primary-pink hover:underline">ارسال رسالة</a>
                </div>
                
                <div class="bg-white rounded-xl shadow-md p-6 text-center">
                    <div class="w-16 h-16 bg-primary-pink bg-opacity-20 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fab fa-instagram text-2xl text-primary-pink"></i>
                    </div>
                    <h3 class="text-xl font-semibold mb-2">إنستجرام</h3>
                    <p class="text-gray-600 mb-2">@haiya.ksa</p>
                    <a href="https://instagram.com/haiya.ksa" class="text-primary-pink hover:underline">زيارة الصفحة</a>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="bg-primary-dark text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <div class="mb-6 md:mb-0">
                    <div class="flex items-center space-x-2">
                        <!-- Logo in footer - replace src with your actual logo path -->
                        <img src="logo.png" alt="هيّا" class="logo-img">
                    </div>
                    <p class="mt-2 text-gray-300">صُنع بعد سنين من الانتظار، لجعل الرياضة متاحة لجميع النساء
Ladies, it's time!</p>
                </div>
                
                <div class="flex space-x-6 space-x-reverse">
                    <a href="https://instagram.com/haiya.ksa" class="hover:text-primary-pink transition">
                        <i class="fab fa-instagram text-2xl"></i>
                    </a>
                    <a href="https://wa.me/966582068727" class="hover:text-primary-pink transition">
                        <i class="fab fa-whatsapp text-2xl"></i>
                    </a>
                </div>
            </div>
            
            <div class="border-t border-gray-700 mt-8 pt-8 text-center text-gray-300">
                <p>© <script>document.write(new Date().getFullYear())</script> هيّا. جميع الحقوق محفوظة.</p>
            </div>
        </div>
    </footer>

   <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-check text-3xl text-green-500"></i>
            </div>
            <h3 class="text-2xl font-bold mb-4">تم الحجز بنجاح!</h3>
            <p class="text-gray-600 mb-6" id="success-message">تم تأكيد حجزك بنجاح وسنتواصل معك قريباً.</p>
            <p class="text-gray-600 mb-6">يرجى إرسال إثبات التحويل عبر الواتساب لتأكيد الحجز.</p>
            <button id="close-modal" class="bg-primary-pink hover:bg-opacity-90 text-white font-bold py-2 px-6 rounded-lg transition">
                حسناً
            </button>
        </div>
    </div>

<script>
    // Firebase SDK v8 (compatible with GitHub Pages)
    // Your Firebase config and initialization
    const firebaseConfig = {
        apiKey: "AIzaSyARaAimHiNzNef6AZ2LKHl0a2V_euo2JYg",
        authDomain: "booking-haiya.firebaseapp.com",
        databaseURL: "https://booking-haiya-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "booking-haiya",
        storageBucket: "booking-haiya.appspot.com",
        messagingSenderId: "920297070543",
        appId: "1:920297070543:web:3e216c54a933b493fcfcba",
        measurementId: "G-57T61BEJWD"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); // This initializes your database connection

    // ========== ORIGINAL CONFIGURATION SECTION (YOUR SCHEDULE DATA) ==========
    const citySchedules = {
        "بريدة": {
            "كرة السلة": {
                availableDays: [0, 2, 4], // Sunday, Tuesday, Thursday
                timeSlots: [{
                    time: '4:00 مساءً',
                    available: 5,
                    max: 10,
                    price: 75
                }, {
                    time: '6:00 مساءً',
                    available: 8,
                    max: 10,
                    price: 75
                }]
            },
            "تنس الريشة": {
                availableDays: [1, 3], // Monday, Wednesday
                timeSlots: [{
                    time: '5:00 مساءً',
                    available: 4,
                    max: 8,
                    price: 60
                }]
            },
            "كرة القدم": {
                availableDays: [0, 3, 5], // Sunday, Wednesday, Friday
                timeSlots: [{
                    time: '5:30 مساءً',
                    available: 7,
                    max: 12,
                    price: 80
                }]
            },
            "كرة الطائرة": {
                availableDays: [1, 4], // Monday, Thursday
                timeSlots: [{
                    time: '4:00 مساءً',
                    available: 6,
                    max: 12,
                    price: 70
                }]
            },
            "التنس": {
                availableDays: [2, 5], // Tuesday, Friday
                timeSlots: [{
                    time: '3:30 مساءً',
                    available: 2,
                    max: 4,
                    price: 90
                }]
            },
            "السهام": {
                availableDays: [0, 3], // Sunday, Wednesday
                timeSlots: [{
                    time: '4:00 مساءً',
                    available: 3,
                    max: 6,
                    price: 65
                }]
            }
        },
        "عنيزة": {
            "كرة السلة": {
                availableDays: [1, 3], // Monday, Wednesday
                timeSlots: [{
                    time: '5:00 مساءً',
                    available: 4,
                    max: 8,
                    price: 75
                }]
            },
            "كرة القدم": {
                availableDays: [0, 4], // Sunday, Thursday
                timeSlots: [{
                    time: '6:00 مساءً',
                    available: 6,
                    max: 10,
                    price: 80
                }]
            }
        },
        "الرس": {
            "كرة السلة": {
                availableDays: [2, 5], // Tuesday, Friday
                timeSlots: [{
                    time: '4:30 مساءً',
                    available: 5,
                    max: 8,
                    price: 75
                }]
            }
        },
        "البدائع": {
            "كرة القدم": {
                availableDays: [1, 4], // Monday, Thursday
                timeSlots: [{
                    time: '5:00 مساءً',
                    available: 5,
                    max: 10,
                    price: 80
                }]
            }
        }
    };

    // Mobile menu toggle
    document.getElementById('mobile-menu-button').addEventListener('click', function() {
        const menu = document.getElementById('mobile-menu');
        menu.classList.toggle('hidden');
    });

    // Smooth scrolling for navigation links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('href');
            const targetElement = document.querySelector(targetId);
            if (targetElement) {
                targetElement.scrollIntoView({
                    behavior: 'smooth'
                });
                document.getElementById('mobile-menu').classList.add('hidden');
            }
        });
    });

    // City selection
    const cityButtons = document.querySelectorAll('.city-btn');
    let selectedCity = 'بريدة'; // Default city
    let selectedSport = ''; // Initialize selectedSport

    cityButtons.forEach(button => {
        button.addEventListener('click', function() {
            cityButtons.forEach(btn => {
                btn.classList.remove('bg-primary-dark', 'text-white');
                btn.classList.add('bg-gray-200', 'hover:bg-gray-300');
            });
            this.classList.remove('bg-gray-200', 'hover:bg-gray-300');
            this.classList.add('bg-primary-dark', 'text-white', 'hover:bg-opacity-90');
            selectedCity = this.dataset.city;
            document.getElementById('city-name').textContent = selectedCity;
            document.getElementById('booking-city').textContent = selectedCity; // Update booking city

            // If a sport is already selected, re-generate calendar (which triggers showTimeSlots)
            if (selectedSport) {
                generateCalendar();
            }
        });
    });

    // Calendar navigation
    let currentWeek = 0;
    document.getElementById('prev-week').addEventListener('click', function() {
        currentWeek--;
        generateCalendar();
    });

    document.getElementById('next-week').addEventListener('click', function() {
        currentWeek++;
        generateCalendar();
    });

    // Back to activities button
    document.querySelector('.back-to-activities').addEventListener('click', function() {
        document.getElementById('calendar-section').classList.add('hidden');
        document.getElementById('time-slots-container').classList.add('hidden');
        document.getElementById('activities').scrollIntoView({
            behavior: 'smooth'
        });
    });

    // View calendar for a sport
    const viewCalendarButtons = document.querySelectorAll('.view-calendar-btn');

    viewCalendarButtons.forEach(button => {
        button.addEventListener('click', function() {
            selectedSport = this.dataset.sport;
            document.getElementById('sport-name').textContent = selectedSport;
            document.getElementById('city-name').textContent = selectedCity; // Ensure city name is current
            document.getElementById('booking-sport').textContent = selectedSport;
            document.getElementById('booking-city').textContent = selectedCity; // Ensure city is current in booking form

            document.getElementById('calendar-section').classList.remove('hidden');
            document.getElementById('time-slots-container').classList.add('hidden'); // Hide slots until date selected
            generateCalendar(); // Generate calendar with days for the selected sport/city
            document.getElementById('calendar-section').scrollIntoView({
                behavior: 'smooth'
            });
        });
    });

    // Generate calendar days
    function generateCalendar() {
        const calendarDays = document.getElementById('calendar-days');
        calendarDays.innerHTML = '';

        const today = new Date();
        // Set today's time to 00:00:00 to ensure consistent "past" comparison
        today.setHours(0, 0, 0, 0);

        const startDate = new Date(today);
        startDate.setDate(today.getDate() + (currentWeek * 7) - today.getDay());

        // Update week range display
        const weekEndDate = new Date(startDate);
        weekEndDate.setDate(startDate.getDate() + 6);

        const options = {
            day: 'numeric',
            month: 'long'
        };
        const startDateStr = startDate.toLocaleDateString('ar-EG', options);
        const endDateStr = weekEndDate.toLocaleDateString('ar-EG', options);

        document.getElementById('week-range').textContent = `${startDateStr} - ${endDateStr}`;

        // Get schedule for current city and sport
        const sportSchedule = citySchedules[selectedCity]?.[selectedSport] || {};
        const availableDays = sportSchedule.availableDays || [];

        // Generate days
        for (let i = 0; i < 7; i++) {
            const dayDate = new Date(startDate);
            dayDate.setDate(startDate.getDate() + i);
            dayDate.setHours(0, 0, 0, 0); // Normalize dayDate for comparison

            const dayElement = document.createElement('div');
            const isAvailable = availableDays.includes(dayDate.getDay());
            // Check if dayDate is strictly before today, meaning it's a past day
            const isPast = dayDate < today;

            dayElement.className = `calendar-day bg-white rounded-lg p-4 text-center border ${
                    isAvailable && !isPast ? 'cursor-pointer border-gray-200 hover:bg-primary-pink hover:text-white' : 'opacity-50 cursor-not-allowed border-gray-100'
                }`;

            if (dayDate.toDateString() === today.toDateString()) {
                dayElement.classList.add('border-primary-pink', 'border-2');
            }

            dayElement.innerHTML = `
                    <div class="font-bold">${dayDate.toLocaleDateString('ar-EG', { weekday: 'long' })}</div>
                    <div class="text-2xl my-2">${dayDate.getDate()}</div>
                    <div class="text-sm text-gray-500">${dayDate.toLocaleDateString('ar-EG', { month: 'long' })}</div>
                `;

            if (isAvailable && !isPast) {
                dayElement.addEventListener('click', function() {
                    document.querySelectorAll('.calendar-day').forEach(day => {
                        day.classList.remove('active-day');
                    });
                    this.classList.add('active-day');
                    showTimeSlots(dayDate, sportSchedule.timeSlots);
                    // Explicitly trigger update for the newly shown time slots
                    db.ref('bookings').once('value').then(snapshot => updateTimeSlotAvailability(snapshot));
                });
            }

            calendarDays.appendChild(dayElement);
        }
    }

    // MODIFIED: Show time slots for a selected day. This now creates elements
    // for updateTimeSlotAvailability to later fill with real-time data.
    function showTimeSlots(date, slots) {
        const timeSlotsContainer = document.getElementById('time-slots-container');
        const timeSlots = document.getElementById('time-slots');
        const selectedDateElement = document.getElementById('selected-date').querySelector('span');

        const options = {
            weekday: 'long',
            day: 'numeric',
            month: 'long'
        };
        // Use 'en-CA' for data-date attribute to ensure consistent YYYY-MM-DD format for Firebase keys
        const formattedDateForDisplay = date.toLocaleDateString('ar-EG', options);
        const formattedDateForData = date.toLocaleDateString('en-CA', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit'
        });

        selectedDateElement.textContent = formattedDateForDisplay;
        document.getElementById('booking-date').textContent = formattedDateForDisplay;
        document.getElementById('hidden-date').value = formattedDateForDisplay;
        document.getElementById('hidden-formatted-date').value = formattedDateForData; // Set the new hidden input

        timeSlots.innerHTML = ''; // Clear previous slots

        (slots || []).forEach(slot => {
            const slotElement = document.createElement('div');
            // Initial styling for button - availability will be updated by updateTimeSlotAvailability
            slotElement.className = 'bg-white rounded-lg p-4 border border-gray-200';
            slotElement.innerHTML = `
                    <button class="time-slot-btn w-full mt-2 py-2 rounded-lg bg-primary-pink hover:bg-opacity-90 text-white transition"
                            data-date="${formattedDateForData}"
                            data-time="${slot.time}"
                            data-price="${slot.price}"
                            data-max-capacity="${slot.max}">
                        <span class="font-bold">${slot.time}</span> <span class="availability-count">(جارٍ التحميل...)</span><br>
                        <span class="text-sm text-gray-600">السعر: ${slot.price} ريال</span>
                    </button>
                `;

            slotElement.querySelector('button').addEventListener('click', function() {
                // Remove active state from other time slots
                document.querySelectorAll('.time-slot-btn').forEach(btn => {
                    btn.classList.remove('border-2', 'border-blue-500'); // Example active style
                });
                // Add active state to selected time slot
                this.classList.add('border-2', 'border-blue-500'); // Example active style

                document.getElementById('booking-time').textContent = slot.time;
                document.getElementById('booking-price').textContent = `${slot.price} ريال`;
                document.getElementById('hidden-time').value = slot.time;
                document.getElementById('hidden-price').value = `${slot.price} ريال`;
                document.getElementById('booking').scrollIntoView({
                    behavior: 'smooth'
                });
            });

            timeSlots.appendChild(slotElement);
        });

        timeSlotsContainer.classList.remove('hidden');
        // The global Firebase listener will call updateTimeSlotAvailability once these new elements are in the DOM.
    }


    // =============================================================
    // NEW: Function to update time slot availability counts (uses Firebase and citySchedules.max)
    // =============================================================
    function updateTimeSlotAvailability(bookingsSnapshot) {
        const bookedSlotsCount = {};

        // 1. Count current bookings from Firebase
        bookingsSnapshot.forEach(childSnapshot => {
            const booking = childSnapshot.val();
            // Ensure all necessary fields exist to create the key and use the YYYY-MM-DD date
            if (booking.date && booking.time && booking.city && booking.sport) {
                const slotKey = `${booking.date}_${booking.time}_${booking.city}_${booking.sport}`;
                if (bookedSlotsCount[slotKey]) {
                    bookedSlotsCount[slotKey]++;
                } else {
                    bookedSlotsCount[slotKey] = 1;
                }
            }
        });

        // 2. Update all relevant time slot buttons currently displayed
        document.querySelectorAll('.time-slot-btn').forEach(button => {
            const date = button.dataset.date; // Date from data-attribute (YYYY-MM-DD)
            const time = button.dataset.time;
            const city = document.getElementById('booking-city').textContent; // Get currently selected city
            const sport = document.getElementById('booking-sport').textContent; // Get currently selected sport

            // Get the max capacity from citySchedules based on current city, sport, and time
            const sportSchedule = citySchedules[city]?.[sport];
            let totalAvailablePerSlot = 0;
            if (sportSchedule) {
                const matchingSlot = sportSchedule.timeSlots.find(s => s.time === time);
                if (matchingSlot) {
                    totalAvailablePerSlot = matchingSlot.max;
                }
            }

            const slotKey = `${date}_${time}_${city}_${sport}`;
            const booked = bookedSlotsCount[slotKey] || 0;
            let remaining = totalAvailablePerSlot - booked;
            if (remaining < 0) remaining = 0; // Ensure no negative availability

            let availabilitySpan = button.querySelector('.availability-count');
            if (!availabilitySpan) {
                availabilitySpan = document.createElement('span');
                availabilitySpan.className = 'availability-count text-sm text-gray-500 mr-1';
                button.prepend(availabilitySpan);
            }
            availabilitySpan.textContent = `(${remaining}/${totalAvailablePerSlot})`;


            // Update button styling and disable status based on actual availability
            if (remaining <= 0) {
                button.classList.add('bg-gray-200', 'text-gray-500', 'cursor-not-allowed'); // Change to gray for full
                button.classList.remove('bg-primary-pink', 'hover:bg-opacity-90', 'text-white', 'border-blue-500'); // Remove active/original styles
                button.disabled = true;
                // Update the time display to show "اكتمل العدد"
                button.querySelector('span.font-bold').textContent = `${time} - اكتمل العدد`;
            } else {
                button.classList.remove('bg-gray-200', 'text-gray-500', 'cursor-not-allowed');
                button.classList.add('bg-primary-pink', 'hover:bg-opacity-90', 'text-white');
                button.disabled = false;
                // Reset the time display
                button.querySelector('span.font-bold').textContent = time;
            }
        });
    }

    // Attach a real-time listener to Firebase bookings
    // This function will run every time there's a change in the 'bookings' node
    // or when the page first loads.
    db.ref('bookings').on('value', (snapshot) => {
        updateTimeSlotAvailability(snapshot);
    });

    // ========== DUAL SUBMISSION HANDLER ==========
    document.getElementById('booking-form').addEventListener('submit', async function(e) {
        e.preventDefault();

        // Validate form
        if (!document.getElementById('terms').checked) {
            alert('يرجى الموافقة على الشروط والأحكام');
            return;
        }

        // Get form data
        const formData = {
            sport: document.getElementById('booking-sport').textContent,
            city: document.getElementById('booking-city').textContent,
            date: document.getElementById('booking-date').textContent, // For display in success message
            time: document.getElementById('booking-time').textContent,
            price: document.getElementById('booking-price').textContent,
            fullName: document.getElementById('full-name').value,
            phone: document.getElementById('phone').value,
            email: document.getElementById('email').value,
            notes: document.getElementById('notes').value
        };

        // Get the date to save to Firebase directly from the hidden input (YYYY-MM-DD)
        const dateToSave = document.getElementById('hidden-formatted-date').value;

        // Validate required fields (add dateToSave to validation)
        if (!formData.fullName || !formData.phone || !formData.sport || !formData.city || !dateToSave || !formData.time) {
            alert('يرجى ملء جميع الحقول المطلوبة واختيار موعد.');
            return;
        }

        // Set loading state
        const submitBtn = document.querySelector('#booking-form button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';

        try {
            // 1. FIRST: Try saving to Firebase
            let firebaseSuccess = false;
            try {
                const bookingData = {
                    sport: formData.sport,
                    city: formData.city,
                    date: dateToSave, // Use the reliable YYYY-MM-DD date
                    time: formData.time,
                    price: formData.price,
                    fullName: formData.fullName,
                    phone: formData.phone,
                    email: formData.email,
                    notes: formData.notes,
                    status: "Pending",
                    timestamp: firebase.database.ServerValue.TIMESTAMP, // Use Firebase server timestamp
                    compositeKey: `${formData.city}_${formData.sport}_${dateToSave}_${formData.time}`
                };
                await db.ref('bookings').push(bookingData); // Use the 'db' object defined globally
                firebaseSuccess = true;
                console.log("Firebase save successful");
            } catch (firebaseError) {
                console.error("Firebase error:", firebaseError);
            }

            // 2. SECOND: Try sending email via FormSubmit
            let formSubmitSuccess = false;
            try {
                // Ensure hidden fields reflect the latest data for FormSubmit
                document.getElementById('hidden-sport').value = formData.sport;
                document.getElementById('hidden-city').value = formData.city;
                document.getElementById('hidden-date').value = formData.date; // Send display date to email
                document.getElementById('hidden-time').value = formData.time;
                document.getElementById('hidden-price').value = formData.price;
                // The main form inputs (full-name, phone, email, notes) should already have values
                // from formData, so FormSubmit will pick them up if they are named correctly.

                const form = e.target;
                const formAction = form.getAttribute('action');
                const formSubmitResponse = await fetch(formAction, {
                    method: 'POST',
                    body: new FormData(form),
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (formSubmitResponse.ok) {
                    formSubmitSuccess = true;
                    console.log("FormSubmit successful");
                } else {
                    throw new Error(`FormSubmit failed with status: ${formSubmitResponse.status}`);
                }
            } catch (formSubmitError) {
                console.error("FormSubmit error:", formSubmitError);
            }

            // 3. Show appropriate message based on results
            if (firebaseSuccess && formSubmitSuccess) {
                // Both succeeded
                document.getElementById('success-message').textContent =
                    `تم تأكيد حجزك لرياضة ${formData.sport} في ${formData.city} بتاريخ ${formData.date} في ${formData.time}`;
                document.getElementById('success-modal').classList.remove('hidden');
                e.target.reset(); // Clear the form
            } else if (!firebaseSuccess && !formSubmitSuccess) {
                // Both failed
                alert('فشل في إتمام الحجز (فشل حفظ البيانات وإرسال الإيميل). يرجى التواصل عبر الواتساب.');
            } else {
                // Partial success
                const message = firebaseSuccess ?
                    'تم حفظ بيانات حجزك ولكن هناك مشكلة في إرسال الإيميل. يرجى إرسال إثبات التحويل عبر الواتساب لتأكيد موعدك.' :
                    'تم إرسال الإيميل الخاص بحجزك ولكن هناك مشكلة في حفظ البيانات. يرجى التواصل عبر الواتساب للتأكيد.';
                alert(message);

                // Still show success modal if at least one operation worked
                document.getElementById('success-message').textContent =
                    `تم تأكيد حجزك لرياضة ${formData.sport} في ${formData.city} بتاريخ ${formData.date} في ${formData.time}. يرجى مراجعة الملاحظة أعلاه.`;
                document.getElementById('success-modal').classList.remove('hidden');
                e.target.reset(); // Clear the form
            }
        } catch (error) {
            console.error('General error during booking:', error);
            alert('حدث خطأ غير متوقع أثناء إتمام الحجز. يرجى المحاولة مرة أخرى أو التواصل عبر الواتساب.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'تأكيد الحجز';
        }
    });

    // Close modal
    document.getElementById('close-modal').addEventListener('click', function() {
        document.getElementById('success-modal').classList.add('hidden');
    });

    // Initialize default city
    document.querySelector('.city-btn[data-city="بريدة"]').click();
</script>
</body>
</html>
